<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/setup"></ion-back-button>
    </ion-buttons>
    <ion-title>Escrever Confiss√µes</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="confessions-content">
  <div class="confessions-container">
    <!-- Start game button (only when all complete) -->
    <div class="top-actions" *ngIf="canStartGame()">
      <ion-button 
        expand="full"
        size="large"
        (click)="startGame()"
        class="start-game-button">
        <ion-icon name="play" slot="end"></ion-icon>
        Come√ßar Jogo!
      </ion-button>
    </div>

    <!-- Compact player status -->
    <ion-card class="players-status-card">
      <ion-card-content>
        <div class="players-status-compact">
          <div 
            *ngFor="let player of players; let i = index"
            class="player-status-icon"
            [class.current]="i === currentPlayerIndex"
            [class.completed]="isPlayerComplete(player.id)"
            (click)="selectPlayer(i)">
            <span class="player-avatar">{{ player.avatar }}</span>
            <div class="status-indicator">
              <ion-icon 
                *ngIf="isPlayerComplete(player.id)"
                name="checkmark-circle"
                color="success">
              </ion-icon>
              <span class="count" *ngIf="!isPlayerComplete(player.id)">
                {{ getPlayerConfessions(player.id).length }}/{{ minConfessions }}
              </span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Progress indicator -->
    <ion-card class="progress-card">
      <ion-card-content>
        <div class="progress-info">
          <h2>
            <span class="player-avatar">{{ currentPlayer?.avatar }}</span>
            {{ currentPlayer?.name }}
          </h2>
          <p>Escreva suas confiss√µes ({{ currentPlayerConfessions.length }}/{{ minConfessions }})</p>
          <ion-progress-bar 
            [value]="getProgressValue()"
            color="secondary">
          </ion-progress-bar>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Confession form -->
    <ion-card class="confession-form-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="lock-closed"></ion-icon>
          Nova Confiss√£o
        </ion-card-title>
        <ion-card-subtitle>
          Passe o celular para {{ currentPlayer?.name }} escrever de forma privada
        </ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <form (ngSubmit)="addConfession()" #confessionForm="ngForm">
          <!-- Category selector -->
          <ion-item>
            <ion-label position="stacked">Categoria</ion-label>
            <ion-select 
              [(ngModel)]="selectedCategory"
              name="category"
              placeholder="Escolha uma categoria"
              interface="popover">
              <ion-select-option 
                *ngFor="let category of availableCategories" 
                [value]="category">
                {{ getCategoryEmoji(category) }} {{ category }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Confession text -->
          <ion-item>
            <ion-label position="stacked">Confiss√£o</ion-label>
            <ion-textarea
              [(ngModel)]="confessionText"
              name="confession"
              placeholder="Digite sua confiss√£o..."
              rows="4"
              maxlength="200"
              [counter]="true">
            </ion-textarea>
          </ion-item>

          <!-- Suggestions -->
          <div class="suggestions" *ngIf="suggestions.length > 0 && !confessionText">
            <h4>üí° Sugest√µes para {{ selectedCategory }}:</h4>
            <div class="suggestion-chips">
              <ion-chip 
                *ngFor="let suggestion of suggestions"
                (click)="useSuggestion(suggestion)"
                color="secondary">
                <ion-label>{{ suggestion }}</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Form actions -->
          <div class="form-actions">
            <ion-button 
              type="submit"
              expand="block"
              [disabled]="!isValidConfession()"
              class="add-confession-button">
              <ion-icon name="add-circle" slot="start"></ion-icon>
              Adicionar Confiss√£o
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>

    <!-- Current player confessions -->
    <ion-card class="confessions-list-card" *ngIf="currentPlayerConfessions.length > 0">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="list"></ion-icon>
          Suas Confiss√µes ({{ currentPlayerConfessions.length }})
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="confessions-list">
          <div 
            *ngFor="let confession of currentPlayerConfessions; let i = index"
            class="confession-item">
            <div class="confession-content">
              <div class="confession-category">
                {{ getCategoryEmoji(confession.category) }} {{ confession.category }}
              </div>
              <div class="confession-text">{{ confession.text }}</div>
            </div>
            <ion-button 
              fill="clear" 
              size="small"
              color="danger"
              (click)="removeConfession(confession.id)">
              <ion-icon name="trash"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Toast de erro -->
  <ion-toast
    [isOpen]="showErrorToast"
    [message]="errorMessage"
    duration="3000"
    color="danger"
    position="top"
    (didDismiss)="showErrorToast = false">
  </ion-toast>
</ion-content>
